name: PR Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  checks: write
  pull-requests: write

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

# Cancel in-progress runs for the same PR
concurrency:
  group: pr-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # Detect which files changed
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'requirements*.txt'
            frontend:
              - 'frontend/**'
              - 'package*.json'

  # Backend PR review - only if backend files changed
  backend-pr-review:
    name: Backend PR Review
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: Run backend review
        id: review
        run: |
          chmod +x ./scripts/code-reviewer.sh
          ./scripts/code-reviewer.sh \
            --level standard \
            --target backend \
            --output json \
            -f backend-review.json
        continue-on-error: true

      - name: Comment on PR
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');
            let results;
            try {
              results = JSON.parse(fs.readFileSync('backend-review.json', 'utf8'));
            } catch (e) {
              results = { summary: { passed: 0, failed: 0, total: 0 }, checks: [] };
            }

            const status = results.summary.failed === 0 ? '✅' : '❌';
            const failedChecks = results.checks
              .filter(c => c.status === 'failed')
              .map(c => `- **${c.name}**: Failed`)
              .join('\n');

            const body = `## ${status} Backend Code Review

            | Metric | Value |
            |--------|-------|
            | Total Checks | ${results.summary.total} |
            | Passed | ${results.summary.passed} |
            | Failed | ${results.summary.failed} |

            ${failedChecks ? `### Failed Checks\n${failedChecks}` : ''}

            <details>
            <summary>View Details</summary>

            \`\`\`json
            ${JSON.stringify(results, null, 2).substring(0, 3000)}
            \`\`\`
            </details>`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Backend Code Review')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }

      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-pr-review
          path: backend-review.json

      - name: Fail if review failed
        if: steps.review.outcome == 'failure'
        run: exit 1

  # Frontend PR review - only if frontend files changed
  frontend-pr-review:
    name: Frontend PR Review
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Run frontend review
        id: review
        run: |
          chmod +x ./scripts/code-reviewer.sh
          ./scripts/code-reviewer.sh \
            --level standard \
            --target frontend \
            --output json \
            -f frontend-review.json
        continue-on-error: true

      - name: Comment on PR
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');
            let results;
            try {
              results = JSON.parse(fs.readFileSync('frontend-review.json', 'utf8'));
            } catch (e) {
              results = { summary: { passed: 0, failed: 0, total: 0 }, checks: [] };
            }

            const status = results.summary.failed === 0 ? '✅' : '❌';
            const failedChecks = results.checks
              .filter(c => c.status === 'failed')
              .map(c => `- **${c.name}**: Failed`)
              .join('\n');

            const body = `## ${status} Frontend Code Review

            | Metric | Value |
            |--------|-------|
            | Total Checks | ${results.summary.total} |
            | Passed | ${results.summary.passed} |
            | Failed | ${results.summary.failed} |

            ${failedChecks ? `### Failed Checks\n${failedChecks}` : ''}

            <details>
            <summary>View Details</summary>

            \`\`\`json
            ${JSON.stringify(results, null, 2).substring(0, 3000)}
            \`\`\`
            </details>`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Frontend Code Review')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }

      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-pr-review
          path: frontend-review.json

      - name: Fail if review failed
        if: steps.review.outcome == 'failure'
        run: exit 1

  # Skip message if no relevant changes
  no-changes:
    name: No Review Needed
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend != 'true' && needs.changes.outputs.frontend != 'true'
    steps:
      - name: Skip review
        run: echo "No backend or frontend changes detected. Skipping code review."
